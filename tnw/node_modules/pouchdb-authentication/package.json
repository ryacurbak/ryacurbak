{
  "name": "pouchdb-authentication",
  "version": "0.4.3",
  "description": "PouchDB Authentication",
  "main": "lib/index.js",
  "repository": {
    "type": "git",
    "url": "git://github.com/nolanlawson/pouchdb-authentication.git"
  },
  "scripts": {
    "jshint": "jshint -c .jshintrc lib/*.js test/test.js",
    "build-js": "mkdir -p dist && browserify lib/index.js -o dist/pouchdb.authentication.js",
    "min": "uglifyjs dist/pouchdb.authentication.js -mc > dist/pouchdb.authentication.min.js",
    "build": "npm run build-js && npm run min",
    "dev": "add-cors-to-couchdb && zuul --local 9000 --no-coverage --ui mocha-bdd test/test.js",
    "test": "add-cors-to-couchdb && zuul --phantom --ui mocha-bdd test/test.js"
  },
  "keywords": [
    "pouch",
    "pouchdb",
    "authentication",
    "couch",
    "couchdb"
  ],
  "author": {
    "name": "Nolan Lawson"
  },
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/nolanlawson/pouchdb-authentication/issues"
  },
  "dependencies": {
    "inherits": "2.0.1",
    "lie": "3.0.2",
    "pouchdb": "5.2.1",
    "pouchdb-extend": "0.1.2"
  },
  "devDependencies": {
    "add-cors-to-couchdb": "0.0.4",
    "bluebird": "1.2.4",
    "browserify": "3.44.2",
    "chai": "1.8.1",
    "chai-as-promised": "4.1.1",
    "istanbul": "0.1.46",
    "jshint": "2.3.0",
    "mocha": "1.21.5",
    "phantomjs": "2.1.1",
    "uglify-js": "2.4.24",
    "zuul": "3.9.0"
  },
  "files": [
    "lib",
    "dist"
  ],
  "readme": "PouchDB Authentication [![Build Status](https://travis-ci.org/nolanlawson/pouchdb-authentication.svg?branch=master)](https://travis-ci.org/nolanlawson/pouchdb-authentication)\n=====\n\n<img alt=\"PouchDB Authentication logo by nickcolley\" title=\"PouchDB Authentication logo by nickcolley\" width=\"150px\" src=\"https://raw.githubusercontent.com/nolanlawson/pouchdb-authentication/master/docs/logo.png\"/>\n\nEasy user authentication for PouchDB/CouchDB.\n\n```js\nvar db = new PouchDB('http://mysite:5984/mydb', {skipSetup: true});\ndb.login('batman', 'brucewayne').then(function (batman) {\n  console.log(\"I'm Batman.\");\n  return db.logout();\n});\n```\n\n* [Overview](#overview)\n* [Setup](#setup)\n* [API](#api)\n  * [db.signup()](#dbsignupusername-password--options--callback) \n  * [db.login()](#dbloginusername-password--options--callback)\n  * [db.logout()](#dblogoutcallback)\n  * [db.getSession()](#dbgetsessionopts--callback)\n  * [db.getUser()](#dbgetuserusername--opts-callback)\n  * [db.changePassword()](#user-content-dbchangepasswordusername-password--opts-callback)\n* [CouchDB Authentication recipes](#couchdb-authentication-recipes)\n  * [First step: disable the Admin Party!](#first-step-disable-the-admin-party)\n  * [Everybody can read and write everything](#everybody-can-read-and-write-everything)\n  * [Everybody can read, only some can write (everything)](#everybody-can-read-only-some-can-write-everything)\n  * [Everybody can read, only some can write (some things)](#everybody-can-read-only-some-can-write-some-things)\n  * [Some people can read and write everything](#some-people-can-read-and-write-everything)\n  * [Some people can read (some docs), some people can write (those same docs)](#some-people-can-read-some-docs-some-people-can-write-those-same-docs)\n  * [Everybody has to be logged in to do anything](#everybody-has-to-be-logged-in-to-do-anything)\n* [Tests](#tests)\n* [License](#license)\n\nOverview\n----------\n\nYou know what's hard?  **Security**.  You know what makes security really easy?  **CouchDB**.\n\nThat's right, CouchDB is more than a database: it's also a RESTful web server with a built-in authentication framework. And it boasts some top-notch security features:\n\n* **salts and hashes** passwords automatically with [PBKDF2](https://en.wikipedia.org/wiki/PBKDF2)\n* **stores a cookie** in the browser\n* **refreshes the cookie** every 10 minutes (default)\n\nAnd best of all, CouchDB does it with good ol'-fashioned HTTP. Just open up the network tab and watch the JSON fly back and forth.\n\nTo get started, just install CouchDB, throw in [a little SSL][ssl], and you've got everything you need for your site's authentication.\n\n### Project status\n\nThis plugin uses vanilla CouchDB.  The goal is to give you a lightweight authentication API that doesn't require anything fancy &ndash; no additional server daemons, no third-party providers, just straight-up Pouch and Couch.\n\nSo this is more of a reference implementation than an all-in-one solution. If there's a feature missing that you need, you will probably need to write a custom server (see the [CouchDB Authentication recipes](#couchdb-authentication-recipes) section for details).\n\nThis plugin **does not work in Node.js. It's designed for the browser**.\n\nSetup\n---------\n\n### Requirements\n\n- CouchDB v1.3.0+ or IrisCouch\n- PouchDB v2.0.0+\n\n### PouchDB setup\n\nBower:\n\n    bower install pouchdb\n    bower install pouchdb-authentication\n\nBrowserify :\n\n    npm install pouchdb --save\n    npm install pouchdb-authentication --save\n\n```javascript\nvar PouchDB = require(\"pouchdb\");\nPouchDB.plugin(require('pouchdb-authentication'));\n```\n\nStatic :\n\nOr, just grab the latest `pouchdb.authentication.min.js` from [the releases page](https://github.com/nolanlawson/pouchdb-authentication/releases) and declare it after PouchDB:\n\n```html\n<script src=\"pouchdb-XXX.min.js\"></script>\n<script src=\"pouchdb.authentication.min.js\"></script>\n```\n\n### CouchDB setup\n\nInstall CouchDB:\n\n```\nsudo apt-get install couchdb # debian, ubuntu, etc.\nbrew install couchdb         # mac\n```\n\nOr, get yourself a hosted one at [IrisCouch](http://iriscouch.com/). It works the same.\n\nNext, set up CORS so that PouchDB can access your CouchDB from any URL. For convenience we'll use [add-cors-to-couchdb](https://github.com/pouchdb/add-cors-to-couchdb).\n\n    npm install -g add-cors-to-couchdb # may require sudo\n    add-cors-to-couchdb                # for IrisCouch, see add-cors-to-couchdb instructions\n    \n\nIn a production environment, don't forget to set up [SSL][].\n\n### PouchDB setup\n\nCreate a `PouchDB` attached to an HTTP backend.  This is the one you'll use for `pouchdb-authentication` stuff.\n\n```js\nvar db = new PouchDB('http://localhost:5984/mydb', {skipSetup: true});\n```\n\n*(Note that the users are shared across the entire CouchDB instance, not just `mydb`. Also, the `skipSetup` is to prevent PouchDB from doing any HTTP requests to the server while we're not logged in, which would cause a modal authentication popup.)*\n\nOf course, you'll probably want to sync that database with a local one:\n\n```js\nvar local = new PouchDB('local_db');\nlocal.sync(db, {live: true, retry: true}).on('error', console.log.bind(console));\n```\n\nBut the `pouchdb-authentication` API will operate on your remote `PouchDB` object, not your local one.\n\nAPI\n-------\n\nLike PouchDB, every function takes a Node-style callback of the form `function(error, response)`. Or you can use promises:\n\n```js\ndb.doSomething(args).then(function (response){\n  return db.doSomethingElse(args);\n}).then(function response) {\n  // handle response\n}).catch(function (error) {\n  // handle error\n});\n```\n\nEvery function also takes a set of `options`.  Unless otherwise noted, the only available option is `ajax`, which corresponds to the standard PouchDB ajax options. (See [the PouchDB API](http://pouchdb.com/api.html) for details.)  Currently the only ajax option is `ajax.cache`, which can be set to `true` to disable cache-busting on IE.\n\n#### db.signup(username, password [, options] [, callback])\n\nSign up a new user who doesn't exist yet.  Throws an error if the user already exists or if the username is invalid, or if some network error occurred.  CouchDB has some limitations on user names (e.g. they cannot contain the character `:`).\n\n```js\ndb.signup('batman', 'brucewayne', function (err, response) {\n  if (err) {\n    if (err.name === 'conflict') {\n      // \"batman\" already exists, choose another username\n    } else if (err.name === 'forbidden') {\n      // invalid username\n    } else {\n      // HTTP error, cosmic rays, etc.\n    }\n  }\n});\n```\n\n##### Example response:\n\n```js\n{\n  \"ok\":true,\n  \"id\":\"org.couchdb.user:batman\",\n  \"rev\":\"1-575ed65bb40cbe90dc882ced8044a90f\"\n}\n```\n\n**Note:** Signing up does not automatically log in a user; you will need to call `db.login()` afterwards.\n\n##### Options\n\n* **metadata** : Object of metadata you want to store with the username, e.g. an email address or any other info. Can be as deeply structured as you want.\n\n##### Example:\n\n```js\ndb.signup('robin', 'dickgrayson', {\n  metadata : {\n    email : 'robin@boywonder.com',\n    birthday : '1932-03-27T00:00:00.000Z',\n    likes : ['acrobatics', 'short pants', 'sidekickin\\''],\n  }\n}, function (err, response) {\n  // etc.\n});\n```\n\nNote that CouchDB does not enforce a password policy or a username policy, unless you add a security doc to the `_users` database.\n\nYou can also type `signUp()`.\n\n#### db.login(username, password [, options] [ callback])\n\nLog in an existing user. Throws an error if the user doesn't exist yet, the password is wrong, the HTTP server is unreachable, or a meteor struck your computer. \n\n```js\ndb.login('superman', 'clarkkent', function (err, response) {\n  if (err) {\n    if (err.name === 'unauthorized') {\n      // name or password incorrect\n    } else {\n      // cosmic rays, a meteor, etc.\n    }\n  }\n});\n```\n\n##### Example response:\n\n```js\n{\"ok\":true,\"name\":\"david\",\"roles\":[]}\n```\n\nYou can also type `logIn()`.\n\n#### db.logout([callback])\n\nLogs out whichever user is currently logged in. If nobody's logged in, it does nothing and just returns `{\"ok\" : true}`.\n\n##### Example:\n\n```js\ndb.logout(function (err, response) {\n  if (err) {\n    // network error\n  }\n})\n```\n\n##### Example response:\n\n```js\n{\"ok\":true}\n```\n\nYou can also type `logOut()`.\n\n#### db.getSession([opts] [, callback])\n\nReturns information about the current session.  In other words, this tells you which user is currently logged in.\n\n##### Example:\n\n```js\ndb.getSession(function (err, response) {\n  if (err) {\n    // network error\n  } else if (!response.userCtx.name) {\n    // nobody's logged in\n  } else {\n    // response.userCtx.name is the current user\n  }\n});\n```\n\n##### Example response:\n\n```js\n{\n    \"info\": {\n        \"authenticated\": \"cookie\", \n        \"authentication_db\": \"_users\", \n        \"authentication_handlers\": [\"oauth\", \"cookie\", \"default\"]\n    }, \n    \"ok\": true, \n    \"userCtx\": {\n        \"name\": \"batman\", \n        \"roles\": []\n    }\n}\n\n```\n\n**Note:** `getSession()` returns basic user information, like name and roles, but doesn't return metadata.  If you need the metadata, use `getUser()`.\n\n#### db.getUser(username [, opts][, callback])\n\nReturns the user document associated with a username.  (CouchDB, in a pleasing show of consistency, stores users as JSON documents in the special `_users` database.) This is the primary way to get metadata about a user.\n\n##### Example:\n\n```js\ndb.getUser('aquaman', function (err, response) {\n  if (err) {\n    if (err.name === 'not_found') {\n      // typo, or you don't have the privileges to see this user\n    } else {\n      // some other error\n    }\n  } else {\n    // response is the user object\n  }\n});\n```\n\n##### Example response:\n\n```js\n{\n    \"_id\": \"org.couchdb.user:aquaman\", \n    \"_rev\": \"1-60288b5b056a8af31e910bca2523ea6a\", \n    \"derived_key\": \"05c3314f180faed646af3b77e637ffecf2e3fb93\", \n    \"iterations\": 10, \n    \"name\": \"aquaman\", \n    \"password_scheme\": \"pbkdf2\", \n    \"roles\": [], \n    \"salt\": \"bce14111a559e00587f3e5f207e4a316\", \n    \"type\": \"user\"\n}\n```\n\n**Note:** Only server admins or the user themselves can fetch user data. Otherwise you will get a 404 `not_found` error.\n\n#### db.changePassword(username, password [, opts][, callback])\n\nSet new `password` for user `username`.\n\n##### Example:\n\n```js\ndb.changePassword('spiderman', 'will-remember', function(err, response) {\n  if (err) {\n    if (err.name === 'not_found') {\n      // typo, or you don't have the privileges to see this user\n    } else {\n      // some other error\n    }\n  } else {\n    // response is the user update response\n    // {\n    //   \"ok\": true,\n    //   \"id\": \"org.couchdb.user:spiderman\",\n    //   \"rev\": \"2-09310a62dcc7eea42bf3d4f67e8ff8c4\"\n    // }\n  }\n})\n```\n\n**Note:** Only server admins or the user themselves can change user data. Otherwise you will get a 404 `not_found` error.\n\n\nCouchDB authentication recipes\n------------\n\nSo you just installed CouchDB, but you're not sure how to set up the right user permissions?  Look no further.\n\n### First step: disable the Admin Party!\n\nWhen you first install CouchDB, it will be in the \"Admin Party\" mode, which means everyone is an admin.  You'll want to disable this and create at least one admin user, so that random people can't mess with your CouchDB settings:\n\n![Admin party][]\n\nBelow is a list of recipes for common authentication use cases.\n\n* [Everybody can read and write everything](#everybody-can-read-and-write-everything)\n* [Everybody can read, only some can write (everything)](#everybody-can-read-only-some-can-write-everything)\n* [Everybody can read, only some can write (some things)](#everybody-can-read-only-some-can-write-some-things)\n* [Some people can read and write everything](#some-people-can-read-and-write-everything)\n* [Some people can read (some docs), some people can write (those same docs)](#some-people-can-read-some-docs-some-people-can-write-those-same-docs)\n* [Everybody has to be logged in to do anything](#everybody-has-to-be-logged-in-to-do-anything)\n\n### Everybody can read and write everything\n* Example: a public wiki\n\n#### Howto\n\nJust create a new database; this is the default.  It's very dangerous, though, since users can even overwite the history of a document. So you probably don't want it.\n\n### Everybody can read, only some can write (everything)\n* Example: a blog\n\n#### Howto\n\nCreate a new database, then add a *design doc* with a  `validate_doc_update` function (see [the CouchDB docs](http://guide.couchdb.org/draft/validation.html) for details). This function will be called whenever a document is created, modified, or deleted.  In it, we'll check that the user is either an admin or has the `'blogger'` role.\n    \nThe function looks like this:\n\n```js\nfunction(newDoc, oldDoc, userCtx) {\n  var role = \"blogger\";\n  if (userCtx.roles.indexOf(\"_admin\") === -1 && userCtx.roles.indexOf(role) === -1) {\n    throw({forbidden : \"Only users with role \" + role + \" or an admin can modify this database.\"});\n  }\n}\n```\n\nYou can create the document like this:\n\n    curl -X POST http://admin:password@localhost:5984/mydb \\\n    -H 'content-type:application/json' \\\n    -d $'{\"_id\":\"_design/only_bloggers\",\"validate_doc_update\":\"function (newDoc, oldDoc, userCtx) {\\\\nvar role = \\\\\"blogger\\\\\";\\\\nif (userCtx.roles.indexOf(\\\\\"_admin\\\\\") === -1 && userCtx.roles.indexOf(role) === -1) {\\\\nthrow({forbidden : \\\\\"Only users with role \\\\\" + role + \\\\\" or an admin can modify this database.\\\\\"});\\\\n}\\\\n}\"}'\n\nIn the above command, you will need to change **admin**/**password** (admin and password), **localhost:5984** (your Couch URL), **mydb** (your database), **only_bloggers** (name of the design doc, can be whatever you want), and **blogger** (name of the new role).\n\nYou can also create the document in the Futon interface itself:\n\n![New doc button][]\n\n![Blogger DDoc][]\n\nFrom now on, you can give users the role `\"blogger\"`, so they can add/modify/remove documents. (Only admins can change someone's roles.)\n\n![Blogger][]\n\nAdmins can also modify documents, but they are the only ones who can change the security settings.\n\nEveryone else will get an error if they try to write (but not if they try to read).\n\n    $ curl -X POST http://blogger1:blogger1@localhost:5984/mydb -H 'content-type:application/json' -d '{\"some\" : \"doc\"}'\n    {\"ok\":true,\"id\":\"ef24bec394e1a45f32ea917121002282\",\"rev\":\"1-65c2325c1ab76e8279e6c2e3abc1da69\"}\n    $ curl -X POST http://foobar:foobar@localhost:5984/mydb -H 'content-type:application/json' -d '{\"some\" : \"doc\"}'\n    {\"error\":\"forbidden\",\"reason\":\"Only users with role blogger or an admin can modify this database.\"}\n\n### Everybody can read, only some can write (some things)\n\n* Example: Twitter\n\nIn this example, all tweets are public, but everybody can only create/edit/delete their own tweets.\n\nVery similar to the above, we'll create a *design doc* with a `validate_doc_update` function, but this time we'll also ensure that every document contains a `user` field, and that the `user` field matches the name of the user who's modifying it:\n\n```js\nfunction(newDoc, oldDoc, userCtx) {\n  if (userCtx.roles.indexOf('_admin') === -1 && newDoc.user !== userCtx.name) {\n    throw({forbidden : \"doc.user must be the same as your username.\"});\n  }\n}\n  \n```\n\nHere's a `curl` command you can use:\n\n    curl -X POST http://admin:password@localhost:5984/mydb \\\n    -H 'content-type:application/json' \\\n    -d $'{\"_id\":\"_design/only_correct_user\",\"validate_doc_update\":\"function (newDoc, oldDoc, userCtx) {\\\\nif (userCtx.roles.indexOf(\\'_admin\\') === -1 && newDoc.user !== userCtx.name) {\\\\nthrow({forbidden : \\\\\"doc.user must be the same as your username.\\\\\"});\\\\n}\\\\n}\"}'\n\nIn the above command, you will need to change **admin**/**password** (admin and password), **localhost:5984** (your Couch URL), **mydb** (your database), and **only_correct_user** (name of the design doc, can be whatever you want).\n\nYou can also use the Futon UI to do this.  See the \"blogger\" example above for details.\n\n### Some people can read and write everything\n* Example: a shared company wiki\n\n#### Howto\n\nCreate a new database, then click the \"Security\" button:\n\n![security button][]\n\nSet a new role as the read/write role.  We'll call this one `\"employee\"`:\n\n![employee][]\n\nIn this scheme, only admins can change the security settings, but any user with the role `\"employee\"` can view or add/modify/delete documents. The database is not public; only valid users with the role `\"employee\"` can read from it.\n\nSee the \"blogger\" example above for how to set roles.\n\n### Some people can read (some docs), some people can write (those same docs)\n\n* Example: A private file locker\n\n#### Howto\n\nThe standard practice for this is to set up **one database per user**.  Don't be scared: databases are cheap, and Cloudant says [100k databases per account is not uncommon][cloudant-100k].\n\nAlternatively, if you have users who belong to multiple groups, and each group has a set of documents, then you should use a **one database per role** setup, with CouchDB's [roles system](http://docs.couchdb.org/en/latest/api/database/security.html?highlight=roles).\n\nThen, you just need to set the database to be read-only/write-only for people with the correct user name (or correct role), using the [`db/_security` API](http://docs.couchdb.org/en/latest/api/database/security.html). (See screenshots above for manual steps.)\n\nThere are a few different ways to accomplish this, and unfortunately you can't do it with CouchDB alone (as of this writing).  But here are a few different third-party options you can try:\n\n#### [CouchPerUser](https://github.com/etrepum/couchperuser)\n\nNative CouchDB Erlang plugin that automatically creates one database per user.  Eventually CouchDB will have a plugin repository, and you'll be able to just click a button to install, but for now you have to install manually.\n\n#### [couchdb-dbperuser-provisioning](https://github.com/pegli/couchdb-dbperuser-provisioning)\n\nNode.js daemon to do the same as above.\n\n#### [CouchDB-Selfservice](https://github.com/ocasta/CouchDB-Selfservice)\n\nPython process that gives you a URL to use when registering users, and creates a database for that user on registration.\n\n#### [PHP-on-Couch](https://github.com/dready92/PHP-on-Couch)\n\nPHP library that provides some sugar over the CouchDB API, e.g. for admin stuff.\n\n#### [Hoodie](http://hood.ie)\n\nBatteries-included no-backend framework.  Currently (as of January 2016) being [ported to use PouchDB](https://github.com/hoodiehq/hoodie-client-store).\n\n#### [Pouch.host](https://pouch.host/)\n\n(Work in progress as of January 2015.) Hosted PouchDB Server with per-user read-write access.\n\n### Everybody has to be logged in to do anything\n\n* Example: Medical healthcare records\n\n#### Howto\n\nThe highest level of security offered by CouchDB.  No requests *whatsoever* are allowed from unauthenticated users.\n\nFirst, ensure that at least one CouchDB user has been created (if you've [disabled admin party](#first-step-disable-the-admin-party), you'll already have at least one admin user).  Next, if you're using CORS, ensure the `cors.headers` array contains `authorization` (this should already be set if you've followed [CouchDB setup](#couchdb-setup)).  Finally, set `httpd.require_valid_user` to `true`.\n\nTo prevent browser HTTP basic authentication modal dialogs of ye olde times, we have to be subtle in the way we use PouchDB.  To prevent a rogue unauthenticated request to CouchDB (used to [check whether the remote DB exists][skipsetup]), pass `skipSetup: true` in Pouch's constructor options.  Secondly, to authenticate the request against `_session`, add the HTTP basic authorization header to `db.login()`'s [AJAX options](#api).\n\nExample usage:\n\n```js\nvar user = {\n  name: 'admin',\n  password: 'admin'\n};\n\nvar pouchOpts = {\n  skipSetup: true\n};\n\nvar ajaxOpts = {\n  ajax: {\n    headers: {\n      Authorization: 'Basic ' + window.btoa(user.name + ':' + user.password)\n    }\n  }\n};\n\nvar db = new PouchDB('http://localhost:5984/test', pouchOpts);\n\ndb.login(user.name, user.password, ajaxOpts).then(function() {\n  return db.allDocs();\n}).then(function(docs) {\n  console.log(docs);\n}).catch(function(error) {\n  console.error(error);\n});\n```\n\nTest this library\n------\n\nFirst off:\n\n    npm install\n\nTo test in the browser (locally):\n\n    npm run dev\n\nTo test in PhantomJS:\n\n    npm test\n\nLicense\n----------\n\nApache 2.0\n\n[admin party]: https://raw.githubusercontent.com/nolanlawson/pouchdb-authentication/master/docs/admin_party.png\n[blogger]: https://raw.githubusercontent.com/nolanlawson/pouchdb-authentication/master/docs/blogger.png\n[blogger ddoc]: https://raw.githubusercontent.com/nolanlawson/pouchdb-authentication/master/docs/blogger_ddoc.png\n[new doc button]: https://raw.githubusercontent.com/nolanlawson/pouchdb-authentication/master/docs/new_doc_button.png\n[security button]: https://raw.githubusercontent.com/nolanlawson/pouchdb-authentication/master/docs/security_button.png\n[employee]: https://raw.githubusercontent.com/nolanlawson/pouchdb-authentication/master/docs/employee.png\n[cloudant-100k]: https://mail-archives.apache.org/mod_mbox/couchdb-user/201401.mbox/%3C52CEB873.7080404@ironicdesign.com%3E\n[couchperuser-gist]: https://gist.github.com/nolanlawson/9676093\n[ssl]: https://wiki.apache.org/couchdb/How_to_enable_SSL\n[skipsetup]: https://github.com/pouchdb/pouchdb/blob/e78a30f8a548340335e28efb827cddfcd96d0482/lib/adapters/http.js#L157\n",
  "readmeFilename": "README.md",
  "_id": "pouchdb-authentication@0.4.3",
  "dist": {
    "shasum": "bc1e3c2c41ef0ed062a43386f60853d1d28f30ff"
  },
  "_from": "pouchdb-authentication@^0.4.0",
  "_resolved": "https://registry.npmjs.org/pouchdb-authentication/-/pouchdb-authentication-0.4.3.tgz"
}
